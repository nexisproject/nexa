variables:
  GIT_DEPTH: 0  # 获取完整的 git 历史，避免浅克隆导致推送失败

stages:
  - build
  - release

build:
  stage: build
  tags:
    - shell
  only:
    refs:
      - master
    # changes:
    #   - cmd/nexa/**/*
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  script:
    - |
      make clean
      echo "从源码 cmd/nexa/main.go 中获取版本号..."
      VERSION=$(grep 'var Version = ' cmd/nexa/main.go | awk -F'"' '{print $2}')
      echo "版本号: $VERSION"
      
      echo "获取 Commit Short Hash..."
      COMMIT_HASH=$(git rev-parse --short HEAD)
      echo "Commit Short Hash: $COMMIT_HASH"
      
      echo "获取 Job ID..."
      JOB_ID=$CI_JOB_ID
      
      VERSION="${VERSION}-git${COMMIT_HASH}-build${JOB_ID}"
      echo "最终版本号: $VERSION"
      
      echo "开始跨平台交叉编译..."
      VERSION=$VERSION make all

release:
  stage: release
  tags:
    - shell
  needs: [build]
  only:
    refs:
      - master
    # changes:
    #   - cmd/nexa/**/*
  script:
    - |
      set -e  # 遇到错误立即退出
      
      # 1. 配置 SSH
      echo "配置 SSH..."
      if [ -n "$SSH_PRIVATE_KEY" ] && [ -f "$SSH_PRIVATE_KEY" ]; then
        cp "$SSH_PRIVATE_KEY" /tmp/id_rsa
      else
        echo "$SSH_PRIVATE_KEY" > /tmp/id_rsa
      fi
      chmod 600 /tmp/id_rsa
      eval "$(ssh-agent -s)"
      ssh-add /tmp/id_rsa
      mkdir -p ~/.ssh
      ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 2. 配置 Git 用户
      echo "配置 Git 用户..."
      git config --global user.name "GitLab CI"
      git config --global user.email "ci@nexis.run"
      
      # 2.5. 确保获取完整的 git 历史
      echo "检查并获取完整的 git 历史..."
      if [ -f .git/shallow ]; then
        echo "检测到浅克隆，正在获取完整历史..."
        git fetch --unshallow origin || git fetch --depth=1000000 origin
      fi
      git fetch --all --tags

      # 3. 获取版本号
      echo "获取版本号..."
      VERSION=$(grep 'var Version = ' cmd/nexa/main.go | awk -F'"' '{print $2}')
      COMMIT_HASH=$(git rev-parse --short HEAD)
      JOB_ID=$CI_JOB_ID
      VERSION="${VERSION}-git${COMMIT_HASH}-build${JOB_ID}"
      TAG="v${VERSION}"
      echo "版本标签: $TAG"

      # 4. 验证 GitHub Token
      echo "验证 GitHub Token..."
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "错误: GITHUB_TOKEN 环境变量未设置!"
        echo "请在 GitLab CI/CD Settings -> Variables 中添加 GITHUB_TOKEN"
        exit 1
      fi
      
      # 测试 Token 有效性
      TOKEN_TEST=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user)
      if [ "$TOKEN_TEST" != "200" ]; then
        echo "错误: GitHub Token 无效或已过期 (HTTP $TOKEN_TEST)"
        echo "请检查 GITHUB_TOKEN 是否正确配置"
        echo "Token 需要以下权限: repo (完整仓库访问权限)"
        exit 1
      fi
      echo "GitHub Token 验证成功"

      # 5. 添加 GitHub 远程
      echo "配置 GitHub 远程仓库..."
      git remote | grep -q '^github$' && git remote remove github
      git remote add github git@github.com:nexisproject/nexa.git
  
      # 6. 推送代码和 tag
      echo "创建并推送 tag..."
      git tag -a "$TAG" -m "Release $TAG" || true
      
      if ! git ls-remote --heads github | grep -q -E 'refs/heads/master'; then
        echo "首次推送 master 分支..."
        git push -u github master
      else
        echo "更新 master 分支..."
        git push github master
      fi
      
      echo "推送 tag $TAG..."
      git push github "$TAG" || git push --force github "$TAG"

      # 7. 获取提交日志作为 release notes
      echo "生成 Release Notes..."
      LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
      if [ -n "$LAST_TAG" ]; then
        RELEASE_NOTES=$(git log --pretty=format:'- %s' ${LAST_TAG}..HEAD | head -20)
      else
        RELEASE_NOTES=$(git log --pretty=format:'- %s' HEAD~10..HEAD)
      fi
      
      if [ -z "$RELEASE_NOTES" ]; then 
        RELEASE_NOTES="Auto release by GitLab CI for $TAG"
      fi
      
      # 转义 JSON 特殊字符
      RELEASE_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

      # 8. 发布 GitHub Release 并上传产物
      echo "创建 GitHub Release..."
      API_JSON=$(cat <<EOF
      {
        "tag_name": "$TAG",
        "name": "$TAG",
        "body": "$RELEASE_NOTES",
        "draft": false,
        "prerelease": false
      }
      EOF
      )
      
      RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.github.com/repos/nexisproject/nexa/releases \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$API_JSON")
      
      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
      
      echo "HTTP 状态码: $HTTP_CODE"
      echo "响应内容: $RESPONSE_BODY"
      
      if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
        echo "创建 Release 失败!"
        exit 1
      fi
      
      UPLOAD_URL=$(echo "$RESPONSE_BODY" | grep -o '"upload_url": "[^"]*' | sed 's/"upload_url": "//' | sed 's/{?name,label}//')
      
      if [ -z "$UPLOAD_URL" ]; then
        echo "无法获取上传 URL!"
        exit 1
      fi
      
      echo "上传 URL: $UPLOAD_URL"
      
      # 上传产物
      for file in bin/*; do
        [ -e "$file" ] || continue
        FILENAME=$(basename "$file")
        echo "上传产物: $FILENAME"
        curl -s -w "\nHTTP: %{http_code}\n" -X POST "$UPLOAD_URL?name=$FILENAME" \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @"$file"
      done
      
      echo "Release 发布完成!"
